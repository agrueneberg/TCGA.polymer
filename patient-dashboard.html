<element name="patient-dashboard">
    <link rel="stylesheet" href="base.css" />
    <!-- Polymer.register only works with templates -->
    <template>
        <h2>Patient Dashboard</h2>
        <table>
            <tr>
                <th></th>
                <th>Patient</th>
                <th>Race</th>
                <th>Gender</th>
            </tr>
            <div id="loading" loading="{{loading}}"></div>
            <template id="patient" repeat="{{patients}}">
                <tr>
                    <td><input type="checkbox" class="patient" data-barcode="{{bcr_patient_barcode}}" on-click="togglePatient" /></td>
                    <td>{{bcr_patient_barcode}}</td>
                    <td>{{race}}</td>
                    <td>{{gender}}</td>
                </tr>
            </template>
        </table>
    </template>
    <script>
        Polymer.register(this, {
            patients: [],
            loading: true,
            togglePatient: function (ev) {
                var barcode, index;
                barcode = ev.target.dataset["barcode"];
                index = this.patients.indexOf(barcode);
                if (index === -1) {
                    this.patients.push(barcode);
                } else {
                    this.patients.splice(index, 1);
                }
                this.fire("patient", {
                    patients: this.patients
                });
            },
            ready: function () {
                var customElement, shadowRoot, patientRequest;
             // Capture reference to custom element.
                customElement = this;
             // Capture reference to ShadowRoot so that we can use getElementById.
                shadowRoot = customElement.webkitShadowRoot;
             // Load patient data.
                patientRequest = new XMLHttpRequest();
                patientRequest.open("GET", "https://aproxas.herokuapp.com/?url=https://tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/anonymous/tumor/gbm/bcr/biotab/clin/clinical_patient_gbm.txt");
                patientRequest.onload = function () {
                    var lines, columns, patients, patientTemplate;
                    lines = patientRequest.responseText.split("\n");
                    columns = lines.shift().split("\t");
                    patients = [];
                    lines.map(function (line) {
                     // Filter empty lines.
                        if (line !== "") {
                            var fields, patient;
                            fields = line.split("\t");
                            patient = {};
                            fields.forEach(function (value, idx) {
                                patient[columns[idx]] = value;
                            });
                            patients.push(patient);
                        }
                    });
                    customElement.loading = false;
                    patientTemplate = shadowRoot.getElementById("patient");
                    patientTemplate.model = {
                       patients: patients
                    };
                };
                patientRequest.send(null);
            }
        });
    </script>
</element>
