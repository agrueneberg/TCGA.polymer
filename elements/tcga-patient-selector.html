<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="tcga-patient-selector" attributes="cancerType patients">
    <template>
        <h2>Patients</h2>
        <template if={{loading}}>
            <img src="spinner.gif" />
        </template>
        <template if="{{!loading}}">
            <template if="{{allPatients.length == 0}}">
                <p>No data found.</p>
            </template>
            <template if="{{allPatients.length > 0}}">
                <table>
                    <tr>
                        <th></th>
                        <th>Patient</th>
                        <th>Race</th>
                        <th>Gender</th>
                    </tr>
                    <template repeat="{{patient in allPatients}}">
                        <tr>
                            <td><input type="checkbox" checked="{{patient._selected === true}}" on-click="{{togglePatient}}"></td>
                            <td>{{patient.bcr_patient_barcode}}</td>
                            <td>{{patient.race}}</td>
                            <td>{{patient.gender}}</td>
                        </tr>
                    </template>
                </table>
            </template>
        </template>
    </template>
    <script>
        Polymer("tcga-patient-selector", {
            loading: true,
            cancerType: "gbm",
            cancerTypeChanged: function () {
                var customElement;
                customElement = this;
                customElement.loading = true;
                customElement.loadPatients();
            },
            togglePatient: function (e) {
                var customElement, patient, barcode, index;
                customElement = this;
                patient = e.target.templateInstance.model.patient;
                barcode = patient.bcr_patient_barcode;
                index = customElement.patients.indexOf(barcode);
                if (index === -1) {
                    customElement.patients.push(barcode);
                } else {
                    customElement.patients.splice(index, 1);
                }
                customElement.fire("tcga-patients", {
                    patients: customElement.patients
                });
            },
            created: function () {
                var customElement;
                customElement = this;
                customElement.allPatients = [];
                customElement.patients = [];
            },
            ready: function () {
                var customElement;
                customElement = this;
                customElement.loadPatients();
            },
            loadPatients: function () {
                var customElement, patientRequest;
                customElement = this;
             // Load patient data.
                patientRequest = new XMLHttpRequest();
                patientRequest.open("GET", "https://aproxas.herokuapp.com/?url=https://tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/anonymous/tumor/" + customElement.cancerType + "/bcr/biotab/clin/nationwidechildrens.org_clinical_patient_" + customElement.cancerType + ".txt");
                patientRequest.onload = function () {
                    var patients, lines, columns;
                    patients = [];
                    if (patientRequest.status === 200) {
                        lines = patientRequest.responseText.split("\n");
                     // Skip first header line: obsolete schema?
                        lines.shift();
                     // Get column names.
                        columns = lines.shift().split("\t");
                     // Skip third header line: not sure what it means.
                        lines.shift();
                        lines.map(function (line) {
                         // Filter empty lines.
                            if (line !== "") {
                                var fields, patient;
                                fields = line.split("\t");
                                patient = {};
                                fields.forEach(function (value, idx) {
                                    patient[columns[idx]] = value;
                                });
                                patients.push(patient);
                            }
                        });
                    }
                    customElement.loading = false;
                    customElement.allPatients = patients;
                };
                patientRequest.send(null);
            }
        });
    </script>
</polymer-element>
