<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="patient-dashboard">
    <template>
        <link rel="stylesheet" href="base.css">
        <h2>Patient Dashboard</h2>
        <table>
            <tr>
                <th></th>
                <th>Patient</th>
                <th>Race</th>
                <th>Gender</th>
            </tr>
            <div id="loading" loading="{{loading}}"></div>
            <template id="patient" repeat="{{patients}}">
                <tr>
                    <td><input type="checkbox" class="patient" data-barcode="{{bcr_patient_barcode}}" on-click="{{togglePatient}}"></td>
                    <td>{{bcr_patient_barcode}}</td>
                    <td>{{race}}</td>
                    <td>{{gender}}</td>
                </tr>
            </template>
        </table>
    </template>
    <script>
        Polymer("patient-dashboard", {
            loading: true,
            togglePatient: function (ev) {
                var customElement, barcode, index;
                customElement = this;
                barcode = ev.target.dataset["barcode"];
                index = customElement.patients.indexOf(barcode);
                if (index === -1) {
                    customElement.patients.push(barcode);
                } else {
                    customElement.patients.splice(index, 1);
                }
                customElement.fire("patient", {
                    patients: customElement.patients
                });
            },
            created: function () {
                var customElement;
                customElement = this;
                customElement.patients = [];
            },
            ready: function () {
                var customElement, patientRequest;
                customElement = this;
             // Load patient data.
                patientRequest = new XMLHttpRequest();
                patientRequest.open("GET", "https://aproxas.herokuapp.com/?url=https://tcga-data.nci.nih.gov/tcgafiles/ftp_auth/distro_ftpusers/anonymous/tumor/gbm/bcr/biotab/clin/nationwidechildrens.org_clinical_patient_gbm.txt");
                patientRequest.onload = function () {
                    var lines, columns, patients, patientTemplate;
                    lines = patientRequest.responseText.split("\n");
                 // Skip first header line: obsolete schema?
                    lines.shift();
                 // Get column names.
                    columns = lines.shift().split("\t");
                 // Skip third header line: not sure what it means.
                    lines.shift();
                    patients = [];
                    lines.map(function (line) {
                     // Filter empty lines.
                        if (line !== "") {
                            var fields, patient;
                            fields = line.split("\t");
                            patient = {};
                            fields.forEach(function (value, idx) {
                                patient[columns[idx]] = value;
                            });
                            patients.push(patient);
                        }
                    });
                    customElement.loading = false;
                    patientTemplate = customElement.$.patient;
                    patientTemplate.model = {
                       patients: patients
                    };
                };
                patientRequest.send(null);
            }
        });
    </script>
</polymer-element>
