<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Load dependencies -->
<script src="../bower_components/async/lib/async.js"></script>

<polymer-element name="tcga-rppa" attributes="patients">
    <template>
        <h2>RPPA</h2>
        <template if={{loading}}>
            <img src="spinner.gif" />
        </template>
        <template if="{{!loading}}">
            <table>
                <tr>
                    <th>Patient</th>
                    <th>p53</th>
                    <th>EGFR</th>
                </tr>
                <template repeat="{{sample in samples}}">
                    <tr>
                        <td>{{sample.patientBarcode}}</td>
                        <td>{{sample.expressionLevels.p53}}</td>
                        <td>{{sample.expressionLevels.EGFR}}</td>
                    </tr>
                </template>
            </table>
        </template>
    </template>
    <script>
        var rppaSamples;
        Polymer("tcga-rppa", {
            loading: true,
            patientsChanged: function () {
                var customElement;
                customElement = this;
                if (Array.isArray(customElement.patients) === false) {
                    customElement.patients = [customElement.patients];
                }
             // Prevent from firing while loading data.
                if (customElement.loading === false) {
                    customElement.updateTemplate();
                }
            },
            updateTemplate: function () {
                var customElement, patients, filteredSamples;
                customElement = this;
                if (customElement.patients.length > 0) {
                    filteredSamples = rppaSamples.filter(function (sample) {
                        return customElement.patients.indexOf(sample.patientBarcode) !== -1;
                    });
                } else {
                    filteredSamples = rppaSamples;
                }
                customElement.samples = filteredSamples;
            },
            created: function () {
                var customElement;
                customElement = this;
                customElement.patients = [];
                customElement.samples = [];
            },
            ready: function () {
                var customElement;
                customElement = this;
                customElement.loadRppaData();
            },
            loadRppaData: function () {
                var customElement, fileSearchQuery, fileSearchParams, fileSearchRequest;
                customElement = this;
             // Load links to RPPA files.
                fileSearchQuery = {
                    projectCombo: "1",
                    diseaseCombo: ["1"],
                    dataCategoryCombo: ["7"],
                    dataLevelCombo: ["3"],
                    accessTierCombo: ["1"]
                };
                fileSearchParams = "start=0&limit=50&searchParams=" + encodeURIComponent(JSON.stringify(fileSearchQuery));
                fileSearchRequest = new XMLHttpRequest();
                fileSearchRequest.open("POST", "https://aproxas.herokuapp.com/?url=https://tcga-data.nci.nih.gov/ccg-data-web/search/fileSearch.json");
                fileSearchRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                fileSearchRequest.onload = function () {
                    var response, links;
                    response = JSON.parse(fileSearchRequest.responseText);
                    links = response.dccFileData.filter(function (link) {
                        return link.hasOwnProperty("dataLevel") === true && link.dataLevel === 3;
                    });
                    async.map(links, function (link, callback) {
                        var rppaRequest;
                     // Load RPPA files.
                        rppaRequest = new XMLHttpRequest();
                        rppaRequest.open("GET", "https://aproxas.herokuapp.com/?url=https://tcga-data.nci.nih.gov/" + link.path);
                        rppaRequest.onload = function () {
                            var sampleRef, expressionLevels;
                         // Normalize data.
                            expressionLevels = {};
                            rppaRequest.responseText.split("\n").forEach(function (line, i) {
                                var tuple, antibody, expression;
                             // Ignore empty lines.
                                if (line !== "") {
                                    tuple = line.split("\t");
                                    if (tuple[0] === "Sample REF") {
                                     // Extract Sample REF.
                                        sampleRef = tuple[1];
                                    } else if (tuple[0] === "Composite Element REF") {
                                     // Ignore Composite Element REF.
                                    } else {
                                     // Extract antibodies and their expression levels.
                                        antibody = tuple[0].match(/(.*)-\w+-\w+/)[1];
                                        expression = Number(tuple[1]);
                                        expressionLevels[antibody] = expression;
                                    }
                                }
                            });
                         // Find patient barcode.
                            patientBarcode = link.barcode.substring(0, 12);
                            callback(null, {
                                sampleUuid: sampleRef,
                                patientBarcode: patientBarcode,
                                expressionLevels: expressionLevels
                            });
                        };
                        rppaRequest.send(null);
                    }, function (err, samples) {
                        rppaSamples = samples;
                        customElement.loading = false;
                        customElement.updateTemplate();
                    });
                };
                fileSearchRequest.send(fileSearchParams);
            }
        });
    </script>
</polymer-element>
